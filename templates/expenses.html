{% extends "base.html" %}

{% block content %}
<div class="content">
    <h1 class="page-title">Затраты</h1>

    <!-- Кнопка добавить -->
    <button class="add-button" id="openModalBtn">Добавить</button>

    <!-- Список записей -->
    <div class="records-list" id="expensesList">
        <div class="no-records">Записей нет.</div>
    </div>

</div>

<!-- Модальное окно -->
<div id="modal" class="modal">
    <div class="modal-content">
        <h2 id="modalTitle">Расход</h2>

        <form class="modal-form">
            <input type="hidden" id="expenseId">

            <div class="form-group">
                <label for="service">Услуга</label>
                <select id="service">
                    <option value="">Выберите услугу</option>
                </select>
            </div>

            <div class="form-group">
                <label for="material">Материал</label>
                <select id="material">
                    <option value="">Выберите материал</option>
                </select>
            </div>

            <div class="form-group">
                <label for="quantity">Кол-во</label>
                <input type="number" id="quantity" step="0.01" min="0.01" placeholder="0.00">
            </div>

            <div class="form-group">
                <label for="unit">Ед. измер.</label>
                <select id="unit">
                    <option value="">Выберите единицу измерения</option>
                </select>
            </div>

            <div class="form-buttons">
                <button type="button" class="btn-delete" id="deleteBtn">Удалить</button>
                <button type="button" class="btn-save" id="saveBtn">Сохранить</button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('modal');
        const openModalBtn = document.getElementById('openModalBtn');
        const saveBtn = document.getElementById('saveBtn');
        const deleteBtn = document.getElementById('deleteBtn');
        const serviceSelect = document.getElementById('service');
        const materialSelect = document.getElementById('material');
        const unitSelect = document.getElementById('unit');
        const expensesList = document.getElementById('expensesList');
        const expenseIdInput = document.getElementById('expenseId');
        const modalTitle = document.getElementById('modalTitle');

        let servicesData = [];
        let materialsData = [];
        let currentExpenseId = null;

        // Функция для загрузки расходных материалов с сервера
        function loadExpenses() {
            Promise.all([
                fetch('/services').then(r => r.json()),
                fetch('/supplies').then(r => r.json()),
                fetch('/services_supplies').then(r => r.json())
            ])
            .then(([services, supplies, expenses]) => {
                servicesData = services;
                materialsData = supplies;
                displayExpenses(expenses);
            })
            .catch(error => {
                console.error('Ошибка при загрузке данных:', error);
                expensesList.innerHTML = '<div class="no-records">Ошибка загрузки данных</div>';
            });
        }

        // Функция для получения названия услуги по ID
        function getServiceName(serviceId) {
            const service = servicesData.find(s => s.ID === serviceId);
            return service ? service.name : `Услуга #${serviceId}`;
        }

        // Функция для получения названия материала по ID
        function getMaterialName(materialId) {
            const material = materialsData.find(m => m.ID === materialId);
            return material ? material.name : `Материал #${materialId}`;
        }

        // Функция для отображения расходных материалов в списке
        function displayExpenses(expenses) {
            if (expenses.length === 0) {
                expensesList.innerHTML = '<div class="no-records">Записей нет.</div>';
                return;
            }

            let html = '';

            expenses.forEach((expense, index) => {
                const serviceName = getServiceName(expense.id_services);
                const materialName = getMaterialName(expense.id_supplies);

                html += `
                    <div class="record-card" data-expense-id="${expense.ID}">
                        <div class="record-content">
                            <div class="record-details">
                                <div class="record-number">${index + 1}.</div>
                                <div class="record-service" title="ID: ${expense.id_services}">${serviceName || ''}</div>
                                <div class="record-material" title="ID: ${expense.id_supplies}">${materialName || ''}</div>
                                <div class="record-quantity">${expense.material_consumption || '0'}</div>
                                <div class="record-unit">${expense.units_measurement || 'шт'}</div>
                            </div>
                        </div>
                    </div>
                `;
            });

            expensesList.innerHTML = html;

            // Добавляем обработчики двойного клика
            addDoubleClickHandlers();
        }

        // Функция для добавления обработчиков двойного клика
        function addDoubleClickHandlers() {
            const expenseCards = document.querySelectorAll('.record-card[data-expense-id]');

            expenseCards.forEach(card => {
                card.addEventListener('dblclick', function() {
                    const expenseId = this.getAttribute('data-expense-id');
                    openEditModal(expenseId);
                });
            });
        }

        // Функция для открытия модального окна в режиме редактирования
        function openEditModal(expenseId) {
            currentExpenseId = expenseId;

            // Загружаем данные расходного материала
            fetch(`/services_supplies/${expenseId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Расходный материал не найден');
                    }
                    return response.json();
                })
                .then(expense => {
                    // Заполняем форму данными
                    expenseIdInput.value = expense.ID;
                    serviceSelect.value = expense.id_services;
                    materialSelect.value = expense.id_supplies;
                    document.getElementById('quantity').value = expense.material_consumption;
                    unitSelect.value = expense.units_measurement;

                    // Обновляем заголовок
                    modalTitle.textContent = 'Редактирование расхода';

                    // Загружаем списки и открываем модальное окно
                    loadServices();
                    loadMaterials();
                    loadUnits();

                    modal.style.display = 'block';
                    document.body.style.overflow = 'hidden';
                })
                .catch(error => {
                    console.error('Ошибка при загрузке расходного материала:', error);
                    alert('Ошибка при загрузке расходного материала: ' + error.message);
                });
        }

        // Функция для открытия модального окна в режиме создания
        function openCreateModal() {
            currentExpenseId = null;
            modalTitle.textContent = 'Новый расход';

            // Очищаем форму
            expenseIdInput.value = '';
            serviceSelect.value = '';
            materialSelect.value = '';
            document.getElementById('quantity').value = '';
            unitSelect.value = '';

            // Загружаем списки и открываем модальное окно
            loadServices();
            loadMaterials();
            loadUnits();

            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        // Статический список единиц измерения
        const units = [
            'шт', 'мл', 'г', 'кг', 'л', 'уп', 'пар', 'тюбик', 'банка'
        ];

        // Функция для загрузки услуг из БД
        function loadServices() {
            fetch('/services')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Ошибка загрузки услуг');
                    }
                    return response.json();
                })
                .then(services => {
                    serviceSelect.innerHTML = '<option value="">Выберите услугу</option>';

                    services.forEach(service => {
                        const option = document.createElement('option');
                        option.value = service.ID;
                        option.textContent = `${service.name} - ${service.price} руб.`;
                        serviceSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Ошибка при загрузке услуг:', error);
                    serviceSelect.innerHTML = '<option value="">Ошибка загрузки услуг</option>';
                });
        }

        // Функция для загрузки материалов из БД
        function loadMaterials() {
            fetch('/supplies')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Ошибка загрузки материалов');
                    }
                    return response.json();
                })
                .then(materials => {
                    materialSelect.innerHTML = '<option value="">Выберите материал</option>';

                    materials.forEach(material => {
                        const option = document.createElement('option');
                        option.value = material.ID;
                        option.textContent = `${material.name} - ${material.price} руб.`;
                        materialSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Ошибка при загрузке материалов:', error);
                    materialSelect.innerHTML = '<option value="">Ошибка загрузки материалов</option>';
                });
        }

        // Функция для загрузки единиц измерения (статический список)
        function loadUnits() {
            unitSelect.innerHTML = '<option value="">Выберите единицу измерения</option>';

            units.forEach(unit => {
                const option = document.createElement('option');
                option.value = unit;
                option.textContent = unit;
                unitSelect.appendChild(option);
            });
        }

        // Функция для закрытия модального окна
        function closeModal() {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
            currentExpenseId = null;
        }

        // Открытие модального окна для создания
        openModalBtn.addEventListener('click', openCreateModal);

        // Сохранение данных расходных материалов
        saveBtn.addEventListener('click', function() {
            const serviceValue = serviceSelect.value;
            const materialValue = materialSelect.value;
            const quantityValue = document.getElementById('quantity').value;
            const unitValue = unitSelect.value;

            // Валидация данных
            if (!serviceValue || !materialValue || !quantityValue || !unitValue) {
                alert('Заполните все поля!');
                return;
            }

            const expenseData = {
                id_services: parseInt(serviceValue),
                id_supplies: parseInt(materialValue),
                material_consumption: parseFloat(quantityValue),
                units_measurement: unitValue
            };

            if (isNaN(expenseData.id_services) || isNaN(expenseData.id_supplies) || isNaN(expenseData.material_consumption)) {
                alert('Ошибка в данных! Проверьте правильность введенных значений.');
                return;
            }

            if (expenseData.material_consumption <= 0) {
                alert('Количество должно быть положительным числом!');
                return;
            }

            let url = '/services_supplies';
            let method = 'POST';

            // Если редактируем существующий расход
            if (currentExpenseId) {
                url = `/services_supplies/${currentExpenseId}`;
                method = 'PUT';
            }

            // Отправляем данные на сервер
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(expenseData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text || 'Ошибка сервера');
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Расход материала сохранен:', data);
                alert('Данные успешно сохранены!');
                closeModal();
                loadExpenses();
            })
            .catch(error => {
                console.error('Ошибка при сохранении:', error);
                alert('Ошибка при сохранении: ' + error.message);
            });
        });

        // Удаление расходного материала
        deleteBtn.addEventListener('click', function() {
            if (!currentExpenseId) {
                closeModal();
                return;
            }

            if (!confirm('Вы уверены, что хотите удалить этот расход?')) {
                return;
            }

            fetch(`/services_supplies/${currentExpenseId}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text || 'Ошибка сервера');
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Расход удален:', data);
                alert('Расход успешно удален!');
                closeModal();
                loadExpenses();
            })
            .catch(error => {
                console.error('Ошибка при удалении:', error);

                // Проверяем, содержит ли ошибка информацию о связанных записях
                if (error.message.includes('foreign key') ||
                    error.message.includes('внешний ключ') ||
                    error.message.includes('связан') ||
                    error.message.includes('cannot delete') ||
                    error.message.includes('нарушает')) {
                    alert('Нельзя удалить расход, так как на него есть ссылки в других таблицах!');
                } else {
                    alert('Нельзя удалить расход, так как на него есть ссылки в других таблицах!' + error.message);
                }
            });
        });

        // Закрытие модального окна при клике вне его
        window.addEventListener('click', function(event) {
            if (event.target === modal) {
                closeModal();
            }
        });

        loadExpenses();
    });
</script>
{% endblock %}