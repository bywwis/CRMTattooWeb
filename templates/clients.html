{% extends "base.html" %}

{% block content %}
<div class="content">
    <h1 class="page-title">Клиенты</h1>
    <!-- Фильтры с выпадающими списками -->
    <div class="filters">
        <div class="filter-group">
            <input type="date" class="filter-select" id="dateFilter">
        </div>

        <div class="filter-group">
            <select class="filter-select" id="periodFilter">
                <option value="">День</option>
                <option value="month">Месяц</option>
                <option value="year">Год</option>
            </select>
        </div>
    </div>

    <!-- Кнопка добавить -->
    <button class="add-button" id="openModalBtn">Добавить</button>

    <!-- Список записей -->
    <div class="records-list" id="clientsList">
       <div class="no-records">Записей нет.</div>
    </div>

</div>

<!-- Модальное окно -->
<div id="modal" class="modal">
    <div class="modal-content">
        <h2 id="modalTitle">Клиент</h2>

        <form class="modal-form">
            <input type="hidden" id="clientId">

            <div class="form-group">
                <label for="clientName">Имя</label>
                <input type="text" id="clientName" maxlength="50" pattern="[A-Za-zА-Яа-яЁё\s]+">
            </div>

            <div class="form-group">
                <label for="clientLast">Фамилия</label>
                <input type="text" id="clientLast" maxlength="50" pattern="[A-Za-zА-Яа-яЁё\s]+">
            </div>

            <div class="form-group">
                <label for="clientMiddle">Отчество</label>
                <input type="text" id="clientMiddle" maxlength="50" pattern="[A-Za-zА-Яа-яЁё\s]+">
            </div>

             <div class="form-group">
                <label for="clientTelephone">Тел.</label>
                <input type="text" id="clientTelephone" placeholder="+7 (___) ___-__-__">
            </div>

            <div class="form-buttons">
                <button type="button" class="btn-delete" id="deleteBtn">Удалить</button>
                <button type="button" class="btn-save" id="saveBtn">Сохранить</button>
            </div>
        </form>
    </div>
</div>

<style>
    .filters {
        display: flex;
        justify-content: flex-end;
        gap: 20px;
        margin-bottom: 30px;
        margin: 0 4% 0 auto;
        padding: 20px;
    }

    /* Стиль для плейсхолдера */
    #clientTelephone::placeholder {
        color: #999;
        opacity: 1;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('modal');
        const openModalBtn = document.getElementById('openModalBtn');
        const saveBtn = document.getElementById('saveBtn');
        const deleteBtn = document.getElementById('deleteBtn');
        const telephoneInput = document.getElementById('clientTelephone');
        const clientsList = document.getElementById('clientsList');
        const clientIdInput = document.getElementById('clientId');
        const modalTitle = document.getElementById('modalTitle');
        const dateFilter = document.getElementById('dateFilter');
        const periodFilter = document.getElementById('periodFilter');

        let currentClientId = null;
        let allClients = []; // Все загруженные клиенты с датами записей

        // Получаем ссылки на поля ввода
        const nameInput = document.getElementById('clientName');
        const lastNameInput = document.getElementById('clientLast');
        const middleNameInput = document.getElementById('clientMiddle');

        // Функция для валидации ввода (только буквы и пробелы)
        function validateTextInput(input) {
            // Разрешаем только буквы русского/английского алфавита и пробелы
            input.value = input.value.replace(/[^A-Za-zА-Яа-яЁё\s]/g, '');

            // Убираем множественные пробелы
            input.value = input.value.replace(/\s+/g, ' ');

            // Убираем пробелы в начале и конце
            input.value = input.value.trim();
        }

        // Функция для проверки нажатия клавиш (опционально)
        function allowOnlyLetters(e) {
            const key = e.key;
            // Разрешаем: буквы, пробел, Backspace, Delete, Tab, стрелки
            if (!/^[A-Za-zА-Яа-яЁё\s]$/.test(key) &&
                !['Backspace', 'Delete', 'Tab', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'Home', 'End'].includes(key)) {
                e.preventDefault();
            }
        }

        // Добавляем обработчики событий для каждого поля
        [nameInput, lastNameInput, middleNameInput].forEach(input => {
            // Обработчик ввода
            input.addEventListener('input', function() {
                validateTextInput(this);
            });

            // Обработчик вставки (paste)
            input.addEventListener('paste', function(e) {
                // Даем время на вставку, затем валидируем
                setTimeout(() => {
                    validateTextInput(this);
                }, 0);
            });

            // Обработчик нажатия клавиш (опционально)
            input.addEventListener('keydown', allowOnlyLetters);
        });

        // Функция для применения маски телефона
        function formatPhoneNumber(input) {
            const cursorPosition = input.selectionStart;
            let value = input.value.replace(/\D/g, '');
            
            // Сохраняем позицию курсора относительно цифр
            let digitsBeforeCursor = input.value.substring(0, cursorPosition).replace(/\D/g, '').length;
            
            // Если поле пустое или содержит только начальные символы, показываем начальную маску
            if (value.length === 0 || (value.length === 0 && input.value.includes('+7 ('))) {
                input.value = '+7 (';
                input.setSelectionRange(4, 4);
                return;
            }
            
            // Убираем код страны если он уже есть (7 или 8)
            if (value.startsWith('7') && value.length > 1) {
                value = value.substring(1);
                digitsBeforeCursor = Math.max(0, digitsBeforeCursor - 1);
            } else if (value.startsWith('8') && value.length > 1) {
                value = value.substring(1);
                digitsBeforeCursor = Math.max(0, digitsBeforeCursor - 1);
            }
            
            let formattedValue = '+7 (';
            
            if (value.length > 0) {
                formattedValue += value.substring(0, 3);
            }
            if (value.length > 3) {
                formattedValue += ') ' + value.substring(3, 6);
            }
            if (value.length > 6) {
                formattedValue += '-' + value.substring(6, 8);
            }
            if (value.length > 8) {
                formattedValue += '-' + value.substring(8, 10);
            }
            
            // Обновляем значение только если оно действительно изменилось
            if (input.value !== formattedValue) {
                input.value = formattedValue;
            }
            
            // Восстанавливаем позицию курсора
            let newCursorPosition;
            if (digitsBeforeCursor <= 0) {
                newCursorPosition = 4;
            } else if (digitsBeforeCursor <= 3) {
                newCursorPosition = 4 + digitsBeforeCursor;
            } else if (digitsBeforeCursor <= 6) {
                newCursorPosition = 9 + (digitsBeforeCursor - 3);
            } else if (digitsBeforeCursor <= 8) {
                newCursorPosition = 13 + (digitsBeforeCursor - 6);
            } else {
                newCursorPosition = 16 + (digitsBeforeCursor - 8);
            }
            
            // Убеждаемся, что позиция курсора не выходит за пределы строки
            newCursorPosition = Math.min(newCursorPosition, formattedValue.length);
            input.setSelectionRange(newCursorPosition, newCursorPosition);
        }

        // Функция для установки начальной маски
        function setInitialPhoneMask(input) {
            if (!input.value || input.value === '+7 (' || input.value.replace(/\D/g, '').length === 0) {
                input.value = '+7 (';
                input.setSelectionRange(4, 4);
            }
        }

        // Функция для валидации телефона при сохранении (только цифры)
        function validatePhoneForSave(phone) {
            const digitsOnly = phone.replace(/\D/g, '');
            return digitsOnly.length >= 10 && /^\d+$/.test(digitsOnly);
        }

        // Функция для получения только цифр из телефона
        function getPhoneDigits(phone) {
            return phone.replace(/\D/g, '');
        }

        // Улучшенный обработчик ввода для поля телефона
        telephoneInput.addEventListener('input', function(e) {
            // Игнорируем ввод если это не пользовательский ввод (программные изменения)
            if (e.inputType) {
                formatPhoneNumber(this);
            }
        });

        // Улучшенный обработчик для удаления символов
        telephoneInput.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace') {
                const value = this.value.replace(/\D/g, '');
                const cursorPosition = this.selectionStart;
                
                // Если курсор находится в начале маски "+7 (", предотвращаем удаление
                if (cursorPosition <= 4) {
                    e.preventDefault();
                    return;
                }
                
                // Если после удаления останутся только начальные символы, сбрасываем к начальной маске
                if (value.length <= 1 && cursorPosition <= 4) {
                    setTimeout(() => {
                        setInitialPhoneMask(this);
                    }, 0);
                }
            }
            
            // Запрещаем ввод нецифровых символов (кроме управляющих клавиш)
            if (!/[\d]|Backspace|Delete|Tab|ArrowLeft|ArrowRight|ArrowUp|ArrowDown|Home|End/.test(e.key)) {
                e.preventDefault();
            }
        });

        // Обработчик клика по полю
        telephoneInput.addEventListener('click', function() {
            const value = this.value.replace(/\D/g, '');
            if (value.length === 0) {
                setInitialPhoneMask(this);
            }
        });

        // Обработчик фокуса
        telephoneInput.addEventListener('focus', function() {
            const value = this.value.replace(/\D/g, '');
            if (value.length === 0) {
                setInitialPhoneMask(this);
            } else {
                // Устанавливаем курсор в конец числа
                const formattedLength = this.value.length;
                this.setSelectionRange(formattedLength, formattedLength);
            }
        });

        // Обработчик потери фокуса - очищаем если только маска без цифр
        telephoneInput.addEventListener('blur', function() {
            if (this.value === '+7 (') {
                this.value = '';
            }
        });

        // Функция для загрузки клиентов с сервера вместе с их записями
        function loadClients() {
            Promise.all([
                fetch('/customers').then(r => r.json()),
                fetch('/records').then(r => r.json())
            ])
            .then(([customers, records]) => {
                // Обогащаем клиентов данными о всех записях
                const clientsWithRecords = customers.map(customer => {
                    // Находим все записи этого клиента
                    const clientRecords = records.filter(record =>
                        record.id_customers === customer.ID
                    );

                    return {
                        ...customer,
                        records: clientRecords,
                        has_records: clientRecords.length > 0
                    };
                });

                // Сортируем клиентов по датам всех их записей
                clientsWithRecords.sort((a, b) => {
                    // Клиенты с записями выше тех, у кого нет записей
                    if (a.has_records && !b.has_records) return -1;
                    if (!a.has_records && b.has_records) return 1;
                    if (!a.has_records && !b.has_records) return 0;

                    // Сортируем по самой последней записи среди всех записей клиента
                    const aLatestRecord = getLatestRecordDate(a.records);
                    const bLatestRecord = getLatestRecordDate(b.records);

                    return new Date(bLatestRecord) - new Date(aLatestRecord);
                });

                allClients = clientsWithRecords;
                displayClients(allClients);
            })
            .catch(error => {
                console.error('Ошибка при загрузке данных:', error);
                clientsList.innerHTML = '<div class="no-records">Ошибка загрузки клиентов</div>';
            });
        }

        // Функция для получения самой последней даты записи из всех записей клиента
        function getLatestRecordDate(records) {
            if (!records || records.length === 0) return null;

            const sortedRecords = records
                .filter(record => record.date)
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            return sortedRecords.length > 0 ? sortedRecords[0].date : null;
        }

        // Функция для фильтрации клиентов по дате записи
        function filterClientsByDate(selectedDate) {
            if (!selectedDate) {
                displayClients(allClients);
                return;
            }

            const filteredClients = allClients.filter(client => {
                // Проверяем, есть ли у клиента записи на выбранную дату
                return client.records.some(record => {
                    if (!record.date) return false;

                    const recordDate = new Date(record.date);
                    const filterDate = new Date(selectedDate);

                    return recordDate.toDateString() === filterDate.toDateString();
                });
            });

            displayClients(filteredClients);
        }

        // Функция для фильтрации по периоду от выбранной даты
        function filterClientsByPeriod(period, selectedDate) {
            if (!period || !selectedDate) {
                displayClients(allClients);
                return;
            }

            const baseDate = new Date(selectedDate);
            const filteredClients = allClients.filter(client => {
                // Проверяем, есть ли у клиента записи за выбранный период от выбранной даты
                return client.records.some(record => {
                    if (!record.date) return false;

                    const recordDate = new Date(record.date);

                    switch(period) {
                        case 'day':
                            // Все записи за тот же день, что и выбранная дата
                            return recordDate.toDateString() === baseDate.toDateString();
                        case 'month':
                            // Все записи за тот же месяц и год, что и выбранная дата
                            return recordDate.getMonth() === baseDate.getMonth() &&
                                   recordDate.getFullYear() === baseDate.getFullYear();
                        case 'year':
                            // Все записи за тот же год, что и выбранная дата
                            return recordDate.getFullYear() === baseDate.getFullYear();
                        default:
                            return true;
                    }
                });
            });

            displayClients(filteredClients);
        }

        // Обработчик изменения даты в фильтре
        dateFilter.addEventListener('change', function() {
            const selectedDate = this.value;
            const selectedPeriod = periodFilter.value;

            if (selectedPeriod && selectedDate) {
                // Если выбран и период и дата - фильтруем по периоду от выбранной даты
                filterClientsByPeriod(selectedPeriod, selectedDate);
            } else if (selectedDate) {
                // Если выбрана только дата - фильтруем по конкретной дате
                filterClientsByDate(selectedDate);
            } else {
                // Если ничего не выбрано - показываем всех
                displayClients(allClients);
            }
        });

        // Обработчик изменения периода
        periodFilter.addEventListener('change', function() {
            const selectedPeriod = this.value;
            const selectedDate = dateFilter.value;

            if (selectedPeriod && selectedDate) {
                // Если выбран и период и дата - фильтруем по периоду от выбранной даты
                filterClientsByPeriod(selectedPeriod, selectedDate);
            } else if (selectedPeriod) {
                // Если выбран только период, но не выбрана дата - сбрасываем период
                alert('Сначала выберите дату для фильтрации по периоду');
                this.value = '';
                displayClients(allClients);
            } else {
                // Если период сброшен - показываем всех или фильтруем по дате если она выбрана
                if (selectedDate) {
                    filterClientsByDate(selectedDate);
                } else {
                    displayClients(allClients);
                }
            }
        });

        // Функция для отображения клиентов в списке
        function displayClients(customers) {
            if (customers.length === 0) {
                clientsList.innerHTML = '<div class="no-records">Клиентов не найдено.</div>';
                return;
            }

            let html = '';

            customers.forEach((customer, index) => {
                // Форматируем телефон для отображения в списке - ИСПРАВЛЕННАЯ ЛОГИКА
                let displayPhone = customer.phone || '';
                if (displayPhone && displayPhone.length >= 10) {
                    const digits = displayPhone.replace(/\D/g, '');
                    if (digits.length >= 10) {
                        // Убираем код страны для форматирования
                        let cleanDigits = digits;
                        if (cleanDigits.startsWith('7') && cleanDigits.length >= 11) {
                            cleanDigits = cleanDigits.substring(1);
                        } else if (cleanDigits.startsWith('8') && cleanDigits.length >= 11) {
                            cleanDigits = cleanDigits.substring(1);
                        }
                        displayPhone = formatPhoneFromDigits(cleanDigits);
                    }
                }

                html += `
                    <div class="record-card" data-client-id="${customer.ID}">
                        <div class="record-content">
                            <div class="record-details">
                                <div class="record-number">${index + 1}.</div>
                                <div class="record-name">${customer.name || ''}</div>
                                <div class="record-last">${customer.surname || ''}</div>
                                <div class="record-middle">${customer.patronymic || ''}</div>
                                <div class="record-telephone">${displayPhone}</div>
                            </div>
                        </div>
                    </div>
                `;
            });

            clientsList.innerHTML = html;

            // Добавляем обработчики двойного клика
            addDoubleClickHandlers();
        }

        // Функция для добавления обработчиков двойного клика
        function addDoubleClickHandlers() {
            const clientCards = document.querySelectorAll('.record-card[data-client-id]');

            clientCards.forEach(card => {
                card.addEventListener('dblclick', function() {
                    const clientId = this.getAttribute('data-client-id');
                    openEditModal(clientId);
                });
            });
        }

        // Функция для открытия модального окна в режиме редактирования
        // Функция для открытия модального окна в режиме редактирования
        function openEditModal(clientId) {
            currentClientId = clientId;

            fetch(`/customers/${clientId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Клиент не найден');
                    }
                    return response.json();
                })
                .then(client => {
                    // Заполняем форму данными клиента
                    clientIdInput.value = client.ID;
                    document.getElementById('clientName').value = client.name || '';
                    document.getElementById('clientLast').value = client.surname || '';
                    document.getElementById('clientMiddle').value = client.patronymic || '';

                    // Применяем маску к телефону - ИСПРАВЛЕННАЯ ЛОГИКА
                    const phoneInput = document.getElementById('clientTelephone');
                    if (client.phone && client.phone.length >= 10) {
                        const digits = client.phone.replace(/\D/g, '');

                        // Убираем первую 7 если она есть (так как в маске она уже есть)
                        let cleanDigits = digits;
                        if (cleanDigits.startsWith('7') && cleanDigits.length >= 11) {
                            cleanDigits = cleanDigits.substring(1);
                        } else if (cleanDigits.startsWith('8') && cleanDigits.length >= 11) {
                            cleanDigits = cleanDigits.substring(1);
                        }

                        // Применяем маску
                        phoneInput.value = formatPhoneFromDigits(cleanDigits);
                    } else {
                        setInitialPhoneMask(phoneInput);
                    }

                    // Обновляем заголовок
                    modalTitle.textContent = 'Редактирование клиента';

                    // Открываем модальное окно
                    modal.style.display = 'block';
                    document.body.style.overflow = 'hidden';
                })
                .catch(error => {
                    console.error('Ошибка при загрузке клиента:', error);
                    alert('Ошибка при загрузке клиента: ' + error.message);
                });
        }

        // Функция для форматирования телефона из цифр
        function formatPhoneFromDigits(digits) {
            if (!digits || digits.length < 10) return '+7 (';
            
            // Убираем код страны если он есть
            let cleanDigits = digits;
            if (cleanDigits.startsWith('7') && cleanDigits.length >= 11) {
                cleanDigits = cleanDigits.substring(1);
            } else if (cleanDigits.startsWith('8') && cleanDigits.length >= 11) {
                cleanDigits = cleanDigits.substring(1);
            }
            
            let formattedValue = '+7 (';
            
            if (cleanDigits.length > 0) {
                formattedValue += cleanDigits.substring(0, 3);
            }
            if (cleanDigits.length > 3) {
                formattedValue += ') ' + cleanDigits.substring(3, 6);
            }
            if (cleanDigits.length > 6) {
                formattedValue += '-' + cleanDigits.substring(6, 8);
            }
            if (cleanDigits.length > 8) {
                formattedValue += '-' + cleanDigits.substring(8, 10);
            }
            
            return formattedValue;
        }

        // Функция для открытия модального окна в режиме создания
        function openCreateModal() {
            currentClientId = null;
            modalTitle.textContent = 'Новый клиент';

            // Очищаем форму
            clientIdInput.value = '';
            document.getElementById('clientName').value = '';
            document.getElementById('clientLast').value = '';
            document.getElementById('clientMiddle').value = '';

            // Устанавливаем начальную маску для телефона
            telephoneInput.value = '';
            setInitialPhoneMask(telephoneInput);

            // Открываем модальное окно
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        // Функция для закрытия модального окна
        function closeModal() {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
            currentClientId = null;
        }

        // Открытие модального окна для создания
        openModalBtn.addEventListener('click', openCreateModal);

        // Сохранение клиента
        saveBtn.addEventListener('click', function() {
            const surname = document.getElementById('clientLast').value;
            const name = document.getElementById('clientName').value;
            const patronymic = document.getElementById('clientMiddle').value;
            const phone = document.getElementById('clientTelephone').value;

            // Получаем только цифры из телефона для валидации
            const phoneDigits = getPhoneDigits(phone);

            // Проверяем обязательные поля
            if (!surname || !name || !phoneDigits) {
                alert('Заполните фамилию, имя и телефон!');
                return;
            }

            if (!/^\d+$/.test(phoneDigits)) {
                alert('Телефон должен содержать только цифры!');
                return;
            }

            if (phoneDigits.length < 10) {
                alert('Телефон должен содержать не менее 10 цифр!');
                return;
            }

            const customerData = {
                surname: surname,
                name: name,
                patronymic: patronymic,
                phone: phoneDigits // Сохраняем только цифры
            };

            let url = '/customers';
            let method = 'POST';

            // Если редактируем существующего клиента
            if (currentClientId) {
                url = `/customers/${currentClientId}`;
                method = 'PUT';
            }

            // Отправляем данные на сервер
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(customerData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text || 'Ошибка сервера');
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Клиент сохранен:', data);
                alert('Клиент успешно сохранен!');
                closeModal();
                loadClients();
            })
            .catch(error => {
                console.error('Ошибка при сохранении:', error);
                alert('Ошибка при сохранении: ' + error.message);
            });
        });

        // Удаление клиента
        deleteBtn.addEventListener('click', function() {
            if (!currentClientId) {
                closeModal();
                return;
            }

            if (!confirm('Вы уверены, что хотите удалить этого клиента?')) {
                return;
            }

            fetch(`/customers/${currentClientId}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text || 'Ошибка сервера');
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Клиент удален:', data);
                alert('Клиент успешно удален!');
                closeModal();
                loadClients();
            })
            .catch(error => {
                console.error('Ошибка при удалении:', error);

                // Проверяем, содержит ли ошибка информацию о связанных записях
                if (error.message.includes('связанные записи') ||
                    error.message.includes('foreign key') ||
                    error.message.includes('внешний ключ') ||
                    error.message.includes('нельзя удалить') ||
                    error.message.includes('записи')) {
                    alert('Нельзя удалить клиента, у которого есть записи на услуги!');
                } else {
                    alert('Нельзя удалить клиента, у которого есть записи на услуги!' + error.message);
                }
            });
        });

        // Закрытие модального окна при клике вне его
        window.addEventListener('click', function(event) {
            if (event.target === modal) {
                closeModal();
            }
        });

        //Инициализация
        loadClients();
    });
</script>
{% endblock %}