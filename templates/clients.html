{% extends "base.html" %}

{% block content %}
<div class="content">
    <h1 class="page-title">Клиенты</h1>
    <!-- Фильтры с выпадающими списками -->
    <div class="filters">
        <div class="filter-group">
            <select class="filter-select">
                <option value="">Август</option>
                <option value="january">Январь</option>
                <option value="february">Февраль</option>
                <option value="march">Март</option>
                <option value="april">Апрель</option>
                <option value="may">Май</option>
                <option value="june">Июнь</option>
                <option value="july">Июль</option>
                <option value="august">Август</option>
                <option value="september">Сентябрь</option>
                <option value="october">Октябрь</option>
                <option value="november">Ноябрь</option>
                <option value="december">Декабрь</option>
            </select>
        </div>

        <div class="filter-group">
            <select class="filter-select">
                <option value="">Месяц</option>
                <option value="day">День</option>
                <option value="month">Месяц</option>
                <option value="year">Год</option>
            </select>
        </div>
    </div>

    <!-- Кнопка добавить -->
    <button class="add-button" id="openModalBtn">Добавить</button>

    <!-- Список записей -->
    <div class="records-list" id="clientsList">
       <div class="no-records">Записей нет.</div>
    </div>

</div>

<!-- Модальное окно -->
<div id="modal" class="modal">
    <div class="modal-content">
        <h2 id="modalTitle">Клиент</h2>

        <form class="modal-form">
            <input type="hidden" id="clientId">

            <div class="form-group">
                <label for="clientName">Имя</label>
                <input type="text" id="clientName">
            </div>

            <div class="form-group">
                <label for="clientLast">Фамилия</label>
                <input type="text" id="clientLast">
            </div>

            <div class="form-group">
                <label for="clientMiddle">Отчество</label>
                <input type="text" id="clientMiddle">
            </div>

             <div class="form-group">
                <label for="clientTelephone">Тел.</label>
                <input type="text" id="clientTelephone">
            </div>

            <div class="form-buttons">
                <button type="button" class="btn-delete" id="deleteBtn">Удалить</button>
                <button type="button" class="btn-save" id="saveBtn">Сохранить</button>
            </div>
        </form>
    </div>
</div>

<style>
    .filters {
        display: flex;
        justify-content: flex-end;
        gap: 20px;
        margin-bottom: 30px;
        margin: 0 4% 0 auto;
        padding: 20px;
    }

    .record-card {
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .record-card:hover {
        background-color: #f5f5f5;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('modal');
        const openModalBtn = document.getElementById('openModalBtn');
        const saveBtn = document.getElementById('saveBtn');
        const deleteBtn = document.getElementById('deleteBtn');
        const telephoneInput = document.getElementById('clientTelephone');
        const clientsList = document.getElementById('clientsList');
        const clientIdInput = document.getElementById('clientId');
        const modalTitle = document.getElementById('modalTitle');

        let currentClientId = null;

        // Функция для загрузки клиентов с сервера
        function loadClients() {
            fetch('/customers')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Ошибка загрузки клиентов');
                    }
                    return response.json();
                })
                .then(customers => {
                    displayClients(customers);
                })
                .catch(error => {
                    console.error('Ошибка при загрузке клиентов:', error);
                    clientsList.innerHTML = '<div class="no-records">Ошибка загрузки клиентов</div>';
                });
        }

        // Функция для отображения клиентов в списке
        function displayClients(customers) {
            if (customers.length === 0) {
                clientsList.innerHTML = '<div class="no-records">Записей нет.</div>';
                return;
            }

            let html = '';

            customers.forEach((customer, index) => {
                html += `
                    <div class="record-card" data-client-id="${customer.ID}">
                        <div class="record-content">
                            <div class="record-details">
                                <div class="record-number">${index + 1}.</div>
                                <div class="record-name">${customer.name || ''}</div>
                                <div class="record-last">${customer.surname || ''}</div>
                                <div class="record-middle">${customer.patronymic || ''}</div>
                                <div class="record-telephone">${customer.phone || ''}</div>
                            </div>
                        </div>
                    </div>
                `;
            });

            clientsList.innerHTML = html;

            // Добавляем обработчики двойного клика
            addDoubleClickHandlers();
        }

        // Функция для добавления обработчиков двойного клика
        function addDoubleClickHandlers() {
            const clientCards = document.querySelectorAll('.record-card[data-client-id]');

            clientCards.forEach(card => {
                card.addEventListener('dblclick', function() {
                    const clientId = this.getAttribute('data-client-id');
                    openEditModal(clientId);
                });
            });
        }

        // Функция для открытия модального окна в режиме редактирования
        function openEditModal(clientId) {
            currentClientId = clientId;

            fetch(`/customers/${clientId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Клиент не найден');
                    }
                    return response.json();
                })
                .then(client => {
                    // Заполняем форму данными клиента
                    clientIdInput.value = client.ID;
                    document.getElementById('clientName').value = client.name || '';
                    document.getElementById('clientLast').value = client.surname || '';
                    document.getElementById('clientMiddle').value = client.patronymic || '';
                    document.getElementById('clientTelephone').value = client.phone || '';

                    // Обновляем заголовок
                    modalTitle.textContent = 'Редактирование клиента';

                    // Показываем кнопку удаления
                    deleteBtn.style.display = 'block';

                    // Открываем модальное окно
                    modal.style.display = 'block';
                    document.body.style.overflow = 'hidden';
                })
                .catch(error => {
                    console.error('Ошибка при загрузке клиента:', error);
                    alert('Ошибка при загрузке клиента: ' + error.message);
                });
        }

        // Функция для открытия модального окна в режиме создания
        function openCreateModal() {
            currentClientId = null;
            modalTitle.textContent = 'Новый клиент';
            deleteBtn.style.display = 'none';

            // Очищаем форму
            clientIdInput.value = '';
            document.getElementById('clientName').value = '';
            document.getElementById('clientLast').value = '';
            document.getElementById('clientMiddle').value = '';
            document.getElementById('clientTelephone').value = '';

            // Открываем модальное окно
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        // Функция для валидации телефона (только цифры)
        function validatePhone(input) {
            const cursorPosition = input.selectionStart;
            const newValue = input.value.replace(/[^\d]/g, '');
            input.value = newValue;
            input.setSelectionRange(cursorPosition, cursorPosition);
        }

        // Обработчик ввода для поля телефона
        telephoneInput.addEventListener('input', function() {
            validatePhone(this);
        });

        // Функция для закрытия модального окна
        function closeModal() {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
            currentClientId = null;
        }

        // Открытие модального окна для создания
        openModalBtn.addEventListener('click', openCreateModal);

        // Сохранение клиента
        saveBtn.addEventListener('click', function() {
            const surname = document.getElementById('clientLast').value;
            const name = document.getElementById('clientName').value;
            const patronymic = document.getElementById('clientMiddle').value;
            const phone = document.getElementById('clientTelephone').value;

            // Проверяем обязательные поля
            if (!surname || !name || !phone) {
                alert('Заполните фамилию, имя и телефон!');
                return;
            }

            if (!/^\d+$/.test(phone)) {
                alert('Телефон должен содержать только цифры!');
                return;
            }

            if (phone.length < 10) {
                alert('Телефон должен содержать не менее 10 цифр!');
                return;
            }

            const customerData = {
                surname: surname,
                name: name,
                patronymic: patronymic,
                phone: phone
            };

            let url = '/customers';
            let method = 'POST';

            // Если редактируем существующего клиента
            if (currentClientId) {
                url = `/customers/${currentClientId}`;
                method = 'PUT';
            }

            // Отправляем данные на сервер
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(customerData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text || 'Ошибка сервера');
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Клиент сохранен:', data);
                alert('Клиент успешно сохранен!');
                closeModal();
                loadClients();
            })
            .catch(error => {
                console.error('Ошибка при сохранении:', error);
                alert('Ошибка при сохранении: ' + error.message);
            });
        });

        // Удаление клиента
        // Удаление клиента
        deleteBtn.addEventListener('click', function() {
            if (!currentClientId) {
                alert('Нет клиента для удаления');
                return;
            }

            if (!confirm('Вы уверены, что хотите удалить этого клиента?')) {
                return;
            }

            fetch(`/customers/${currentClientId}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text || 'Ошибка сервера');
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Клиент удален:', data);
                alert('Клиент успешно удален!');
                closeModal();
                loadClients();
            })
            .catch(error => {
                console.error('Ошибка при удалении:', error);

                // Проверяем, содержит ли ошибка информацию о связанных записях
                if (error.message.includes('связанные записи') ||
                    error.message.includes('foreign key') ||
                    error.message.includes('внешний ключ') ||
                    error.message.includes('нельзя удалить') ||
                    error.message.includes('записи')) {
                    alert('Нельзя удалить клиента, у которого есть записи на услуги!');
                } else {
                    alert('Нельзя удалить клиента, у которого есть записи на услуги!' + error.message);
                }
            });
        });

        // Закрытие модального окна при клике вне его
        window.addEventListener('click', function(event) {
            if (event.target === modal) {
                closeModal();
            }
        });

        loadClients();
    });
</script>
{% endblock %}