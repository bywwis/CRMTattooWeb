{% extends "base.html" %}

{% block content %}
<div class="content">
    <h1 class="page-title">Записи</h1>

    <!-- Фильтры с выпадающими списками -->
    <div class="filters">
        <div class="filter-group">
            <select class="filter-select">
                <option value="">Август</option>
                <option value="january">Январь</option>
                <option value="february">Февраль</option>
                <option value="march">Март</option>
                <option value="april">Апрель</option>
                <option value="may">Май</option>
                <option value="june">Июнь</option>
                <option value="july">Июль</option>
                <option value="august">Август</option>
                <option value="september">Сентябрь</option>
                <option value="october">Октябрь</option>
                <option value="november">Ноябрь</option>
                <option value="december">Декабрь</option>
            </select>
        </div>

        <div class="filter-group">
            <select class="filter-select">
                <option value="">Месяц</option>
                <option value="day">День</option>
                <option value="month">Месяц</option>
                <option value="year">Год</option>
            </select>
        </div>
    </div>

    <!-- Кнопка добавить -->
    <button class="add-button" id="openModalBtn">Добавить</button>

    <!-- Список записей -->
    <div class="records-list">
        <div class="record-date">24.08.2025</div>
        <div class="record-card" data-record-id="1">
            <div class="record-content">
                <div class="record-details">
                    <div class="record-number">1.</div>
                    <div class="record-name">Имя клиента</div>
                    <div class="record-tattoo">Название тату</div>
                    <div class="record-service">Название услуги</div>
                    <div class="record-time">14:30</div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Модальное окно -->
<div id="modal" class="modal">
    <div class="modal-content">
        <h2>Запись</h2>

        <form class="modal-form">
            <div class="form-group">
                <label for="clientSelect">Клиент</label>
                <select id="clientSelect">
                    <option value="">Выберите клиента</option>
                </select>
            </div>

            <div class="form-group">
                <label for="tattooName">Тату</label>
                <input type="text" id="tattooName">
            </div>

            <div class="form-group">
                <label for="serviceSelect">Услуга</label>
                <select id="serviceSelect">
                    <option value="">Выберите услугу</option>
                </select>
            </div>

            <div class="form-group">
                <label for="date">Дата</label>
                <input type="datetime-local" id="date">
            </div>

            <div class="form-buttons">
                <button type="button" class="btn-delete" id="deleteBtn">Удалить</button>
                <button type="button" class="btn-save" id="saveBtn">Сохранить</button>
            </div>
        </form>
    </div>
</div>

<style>
    .filters {
        display: flex;
        justify-content: flex-end;
        gap: 20px;
        margin-bottom: 30px;
        margin: 0 4% 0 auto;
        padding: 20px;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('modal');
        const openModalBtn = document.getElementById('openModalBtn');
        const saveBtn = document.getElementById('saveBtn');
        const deleteBtn = document.getElementById('deleteBtn');
        const serviceSelect = document.getElementById('serviceSelect');
        const clientSelect = document.getElementById('clientSelect');

        // Функция для загрузки услуг из базы данных
        function loadServices() {
            fetch('/services')
                .then(response => response.json())
                .then(services => {
                    serviceSelect.innerHTML = '<option value="">Выберите услугу</option>';
                    
                    services.forEach(service => {
                        const option = document.createElement('option');
                        option.value = service.ID; // ID услуги
                        option.textContent = `${service.name} - ${service.price} руб.`;
                        serviceSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Ошибка при загрузке услуг:', error);
                });
        }

        // Функция для загрузки клиентов из базы данных
        function loadClients() {
            fetch('/customers') 
                .then(response => response.json())
                .then(customers => {
                    clientSelect.innerHTML = '<option value="">Выберите клиента</option>';
                    
                    customers.forEach(customer => {
                        const option = document.createElement('option');
                        option.value = customer.ID; // ID клиента
                        option.textContent = `${customer.name} ${customer.phone || ''}`;
                        clientSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Ошибка при загрузке клиентов:', error);
                });
        }

        // Функция для закрытия модального окна
        function closeModal() {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
            // Очищаем форму при закрытии
            document.getElementById('tattooName').value = '';
            document.getElementById('date').value = '';
            clientSelect.value = '';
            serviceSelect.value = '';
        }

        // Открытие модального окна
        openModalBtn.addEventListener('click', function() {
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
            // Загружаем услуги и клиентов при открытии модального окна
            loadServices();
            loadClients();
        });

        // Сохранение записи
        saveBtn.addEventListener('click', function() {
            // Собираем данные из формы
            const recordData = {
                id_customers: parseInt(clientSelect.value), 
                id_services: parseInt(serviceSelect.value), 
                date: document.getElementById('date').value,
                name: document.getElementById('tattooName').value
            };

            console.log('Отправляемые данные:', recordData);

            // Проверяем обязательные поля
            if (!recordData.id_customers || !recordData.id_services || !recordData.date || !recordData.name) {
                alert('Заполните все поля!');
                return;
            }

            // Отправляем данные на сервер
            fetch('/records', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(recordData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка сервера');
                }
                return response.json();
            })
            .then(data => {
                console.log('Запись сохранена:', data);
                alert('Запись успешно сохранена!');
                closeModal();
            })
            .catch(error => {
                console.error('Ошибка при сохранении записи:', error);
                alert('Ошибка при сохранении записи: ' + error.message);
            });
        });

        // Закрытие по кнопке Удалить
        deleteBtn.addEventListener('click', function() {
            closeModal();
        });

    });
</script>
{% endblock %}