{% extends "base.html" %}

{% block content %}
<div class="content">
    <h1 class="page-title">Записи</h1>

    <!-- Фильтры с выпадающими списками -->
    <div class="filters">
        <div class="filter-group">
            <input type="date" class="filter-select">
        </div>

        <div class="filter-group">
            <select class="filter-select">
                <option value="">Период</option>
                <option value="day">День</option>
                <option value="month">Месяц</option>
                <option value="year">Год</option>
            </select>
        </div>
    </div>

    <!-- Кнопка добавить -->
    <button class="add-button" id="openModalBtn">Добавить</button>

    <!-- Список записей -->
    <div class="records-list" id="recordsList">
        <div class="no-records">Записей нет.</div>
        <div class="record-date">24.08.2025</div>
        <div class="record-card" data-record-id="1">
            <div class="record-content">
                <div class="record-number">1.</div>
                <div class="record-details">
                    <div class="record-name">Имя клиента</div>
                    <div class="record-tattoo">Название тату</div>
                    <div class="record-service">Название услуги</div>
                    <div class="record-time">14:30</div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Модальное окно -->
<div id="modal" class="modal">
    <div class="modal-content">
        <h2 id="modalTitle">Запись</h2>

        <form class="modal-form">
            <input type="hidden" id="recordId">

            <div class="form-group">
                <label for="clientSelect">Клиент</label>
                <select id="clientSelect">
                    <option value="">Выберите клиента</option>
                </select>
            </div>

            <div class="form-group">
                <label for="tattooName">Тату</label>
                <input type="text" id="tattooName">
            </div>

            <div class="form-group">
                <label for="serviceSelect">Услуга</label>
                <select id="serviceSelect">
                    <option value="">Выберите услугу</option>
                </select>
            </div>

            <div class="form-group">
                <label for="date">Дата</label>
                <input type="datetime-local" id="date">
            </div>

            <div class="form-buttons">
                <button type="button" class="btn-delete" id="deleteBtn">Удалить</button>
                <button type="button" class="btn-save" id="saveBtn">Сохранить</button>
            </div>
        </form>
    </div>
</div>

<style>
    .filters {
        display: flex;
        justify-content: flex-end;
        gap: 20px;
        margin-bottom: 30px;
        margin: 0 4% 0 auto;
        padding: 20px;
    }

    .record-card {
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .record-card:hover {
        background-color: #f5f5f5;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('modal');
        const openModalBtn = document.getElementById('openModalBtn');
        const saveBtn = document.getElementById('saveBtn');
        const deleteBtn = document.getElementById('deleteBtn');
        const serviceSelect = document.getElementById('serviceSelect');
        const clientSelect = document.getElementById('clientSelect');
        const recordsList = document.getElementById('recordsList');
        const recordIdInput = document.getElementById('recordId');
        const modalTitle = document.getElementById('modalTitle');
        const tattooNameInput = document.getElementById('tattooName');
        const dateInput = document.getElementById('date');
        const dateFilter = document.querySelector('input[type="date"]');

        // Переменные для хранения данных
        let customersData = [];
        let servicesData = [];
        let currentRecordId = null; // ID текущей редактируемой записи
        let allRecords = []; // Все загруженные записи

        function loadRecords() {
            // Загрузка всех необходимых данных параллельно
            Promise.all([
                fetch('/customers').then(r => r.json()),
                fetch('/services').then(r => r.json()),
                fetch('/records').then(r => r.json())
            ])
            .then(([customers, services, records]) => {
                // Сохраняем данные для использования
                customersData = customers;
                servicesData = services;
                allRecords = records;
                // Отображаем записи
                displayRecords(records);
            })
            .catch(error => {
                console.error('Ошибка при загрузке данных:', error);
                recordsList.innerHTML = '<div class="no-records">Ошибка загрузки записей</div>';
            });
        }

        // Функция для фильтрации записей по дате
        function filterRecordsByDate(selectedDate) {
            if (!selectedDate) {
                // Если дата не выбрана, показываем все записи
                displayRecords(allRecords);
                return;
            }

            const filteredRecords = allRecords.filter(record => {
                if (!record.date) return false;
                
                const recordDate = new Date(record.date);
                const filterDate = new Date(selectedDate);
                
                // Сравниваем только даты (игнорируем время)
                return recordDate.toDateString() === filterDate.toDateString();
            });

            displayRecords(filteredRecords);
        }

        // Обработчик изменения даты в фильтре
        dateFilter.addEventListener('change', function() {
            filterRecordsByDate(this.value);
        });

        // Функция для получения данных клиента по ID
        function getCustomerName(customerId) {
            const customer = customersData.find(c => c.ID === customerId);
            return customer ? `${customer.name} ${customer.phone}` : `Клиент #${customerId}`;
        }

        // Функция для получения названия услуги по ID
        function getServiceName(serviceId) {
            const service = servicesData.find(s => s.ID === serviceId);
            return service ? service.name : `Услуга #${serviceId}`;
        }

        // Функция для отображения записей в списке
        function displayRecords(records) {
            // Проверка, есть ли записи
            if (records.length === 0) {
                recordsList.innerHTML = '<div class="no-records">Записей нет.</div>';
                return;
            }

            // Группируем записи по дате
            const groupedRecords = groupRecordsByDate(records);

            // Создаем HTML для отображения
            let html = '';
            let recordCounter = 1;

            // Проходим по всем датам
            for (const [date, dateRecords] of Object.entries(groupedRecords)) {
                // Добавляем заголовок с датой
                html += `<div class="record-date">${formatDate(date)}</div>`;

                // Добавляем записи для этой даты
                dateRecords.forEach(record => {
                    // Преобразуем ID в названия
                    const customerName = getCustomerName(record.id_customers);
                    const serviceName = getServiceName(record.id_services);

                    html += `
                        <div class="record-card" data-record-id="${record.ID}">
                            <div class="record-content">
                                <div class="record-details">
                                    <div class="record-number">${recordCounter}.</div>
                                    <div class="record-name">${customerName}</div>
                                    <div class="record-tattoo">${record.name || 'Не указано'}</div>
                                    <div class="record-service">${serviceName}</div>
                                    <div class="record-time">${formatTime(record.date)}</div>
                                </div>
                            </div>
                        </div>
                    `;
                    recordCounter++;
                });
            }

            recordsList.innerHTML = html;

            // Добавляем обработчики двойного клика для всех записей
            addDoubleClickHandlers();
        }

        // Функция для добавления обработчиков двойного клика
        function addDoubleClickHandlers() {
            const recordCards = document.querySelectorAll('.record-card');

            recordCards.forEach(card => {
                card.addEventListener('dblclick', function() {
                    const recordId = this.getAttribute('data-record-id');
                    openEditModal(recordId);
                });
            });
        }

        // Функция для открытия модального окна в режиме редактирования
        function openEditModal(recordId) {
            currentRecordId = recordId;

            // Загружаем данные записи
             Promise.all([
                loadServices(),
                loadClients()
            ]).then(() => {
                // После загрузки списков загружаем данные записи
                return fetch(`/records/${recordId}`);
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Запись не найдена');
                    }
                    return response.json();
                })
                .then(record => {
                    // Заполняем форму данными записи
                    recordIdInput.value = record.ID;
                    clientSelect.value = record.id_customers;
                    serviceSelect.value = record.id_services;
                    tattooNameInput.value = record.name || '';

                    // Форматируем дату для input[type=datetime-local]
                    if (record.date) {
                        const date = new Date(record.date);
                        const localDateTime = date.toISOString().slice(0, 16);
                        dateInput.value = localDateTime;
                    } else {
                        dateInput.value = '';
                    }

                    // Обновляем заголовок модального окна
                    modalTitle.textContent = 'Редактирование записи';

                    // Показываем кнопку удаления
                    deleteBtn.style.display = 'block';

                    // Открываем модальное окно
                    modal.style.display = 'block';
                    document.body.style.overflow = 'hidden';
                })
                .catch(error => {
                    console.error('Ошибка при загрузке записи:', error);
                    alert('Ошибка при загрузке записи: ' + error.message);
                });
        }

        // Функция для открытия модального окна в режиме создания
        function openCreateModal() {
            currentRecordId = null;
            modalTitle.textContent = 'Новая запись';
            deleteBtn.style.display = 'none';

            // Очищаем форму
            recordIdInput.value = '';
            clientSelect.value = '';
            serviceSelect.value = '';
            tattooNameInput.value = '';
            dateInput.value = '';

            // Загружаем списки
            loadServices();
            loadClients();

            // Открываем модальное окно
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        // Функция для группировки записей по дате
        function groupRecordsByDate(records) {
            const grouped = {};

            records.forEach(record => {
                const date = record.date ? record.date.split('T')[0] : 'Без даты';

                if (!grouped[date]) {
                    grouped[date] = [];
                }

                grouped[date].push(record);
            });

            const sortedGrouped = {};
            Object.keys(grouped)
                .sort((a, b) => new Date(a) - new Date(b))
                .forEach(date => {
                    sortedGrouped[date] = grouped[date];
                });
            return sortedGrouped;
        }

        // Функция для форматирования даты
        function formatDate(dateString) {
            if (dateString === 'Без даты') return dateString;

            const date = new Date(dateString);
            return date.toLocaleDateString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // Функция для форматирования времени
        function formatTime(dateTimeString) {
            if (!dateTimeString) return '--:--';

            const date = new Date(dateTimeString);
            return date.toLocaleTimeString('ru-RU', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Функция для загрузки услуг из базы данных
        function loadServices() {
            fetch('/services')
                .then(response => response.json())
                .then(services => {
                    serviceSelect.innerHTML = '<option value="">Выберите услугу</option>';

                    services.forEach(service => {
                        const option = document.createElement('option');
                        option.value = service.ID; // ID услуги
                        option.textContent = `${service.name} - ${service.price} руб.`;
                        serviceSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Ошибка при загрузке услуг:', error);
                });
        }

        // Функция для загрузки клиентов из базы данных
        function loadClients() {
            fetch('/customers')
                .then(response => response.json())
                .then(customers => {
                    clientSelect.innerHTML = '<option value="">Выберите клиента</option>';

                    customers.forEach(customer => {
                        const option = document.createElement('option');
                        option.value = customer.ID; // ID клиента
                        option.textContent = `${customer.name} ${customer.phone || ''}`;
                        clientSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Ошибка при загрузке клиентов:', error);
                });
        }

        // Функция для закрытия модального окна
        function closeModal() {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
            currentRecordId = null;
        }

        // Открытие модального окна для создания новой записи
        openModalBtn.addEventListener('click', openCreateModal);

        // Сохранение записи
        saveBtn.addEventListener('click', function() {
            // Собираем данные из формы
            const recordData = {
                id_customers: parseInt(clientSelect.value),
                id_services: parseInt(serviceSelect.value),
                date: document.getElementById('date').value,
                name: document.getElementById('tattooName').value
            };

            console.log('Отправляемые данные:', recordData);

            // Проверяем обязательные поля
            if (!recordData.id_customers || !recordData.id_services || !recordData.date || !recordData.name) {
                alert('Заполните все поля!');
                return;
            }

            let url = '/records';
            let method = 'POST';

            // Если редактируем существующую запись
            if (currentRecordId) {
                url = `/records/${currentRecordId}`;
                method = 'PUT';
            }

            // Отправляем данные на сервер
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(recordData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка сервера');
                }
                return response.json();
            })
            .then(data => {
                console.log('Запись сохранена:', data);
                alert('Запись успешно сохранена!');
                closeModal();
                loadRecords();
            })
            .catch(error => {
                console.error('Ошибка при сохранении записи:', error);
                alert('Ошибка при сохранении записи: ' + error.message);
            });
        });

        // Удаление записи
        deleteBtn.addEventListener('click', function() {
            if (!currentRecordId) {
                alert('Нет записи для удаления');
                return;
            }

            if (!confirm('Вы уверены, что хотите удалить эту запись?')) {
                return;
            }

            fetch(`/records/${currentRecordId}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text || 'Ошибка сервера');
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Запись удалена:', data);
                alert('Запись успешно удалена!');
                closeModal();
                loadRecords();
            })
            .catch(error => {
                console.error('Ошибка при удалении записи:', error);

                // Проверяем, содержит ли ошибка информацию о внешних ключах
                if (error.message.includes('foreign key') ||
                    error.message.includes('внешний ключ') ||
                    error.message.includes('связан') ||
                    error.message.includes('cannot delete') ||
                    error.message.includes('нарушает')) {
                    alert('Нельзя удалить запись, так как на нее есть ссылки в других таблицах!');
                } else {
                    alert('Нельзя удалить запись, так как на нее есть ссылки в других таблицах!' + error.message);
                }
            });
        });

        // Закрытие модального окна при клике вне его
        window.addEventListener('click', function(event) {
            if (event.target === modal) {
                closeModal();
            }
        });

        // Инициализация
        loadRecords();
    });
</script>
{% endblock %}