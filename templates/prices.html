{% extends "base.html" %}

{% block content %}
<div class="content">
    <h1 class="page-title">Прайс</h1>

    <!-- Кнопка добавить -->
    <button class="add-button" id="openModalBtn">Добавить</button>

    <!-- Список записей -->
    <div class="records-list" id="servicesList">
        <div class="no-records">Записей нет.</div>
    </div>
</div>

<!-- Модальное окно -->
<div id="modal" class="modal">
    <div class="modal-content">
        <h2>Прайс</h2>

        <form class="modal-form">
            <div class="form-group">
                <label for="name">Название</label>
                <input type="text" id="name">
            </div>

            <div class="form-group">
                <label for="price">Цена</label>
                <input type="text" id="price">
            </div>

            <div class="form-buttons">
                <button type="button" class="btn-delete" id="deleteBtn">Удалить</button>
                <button type="button" class="btn-save" id="saveBtn">Сохранить</button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('modal');
        const openModalBtn = document.getElementById('openModalBtn');
        const saveBtn = document.getElementById('saveBtn');
        const deleteBtn = document.getElementById('deleteBtn');
        const priceInput = document.getElementById('price');
        const servicesList = document.getElementById('servicesList');

        // Функция для загрузки услуг с сервера
        function loadServices() {
            // Отправка GET запроса на endpoint /services
            fetch('/services')
                .then(response => {
                    // Проверка, что ответ от сервера успешный
                    if (!response.ok) {
                        throw new Error('Ошибка загрузки услуг');
                    }
                    // Преобразование ответа в JSON формат
                    return response.json();
                })
                .then(services => {
                    // Если данные успешно получены, передача их в функцию отображения
                    displayServices(services);
                })
                .catch(error => {
                    // Обработка ошибки (сетевые проблемы, ошибки сервера и т.д.)
                    console.error('Ошибка при загрузке услуг:', error);
                    // Показ сообщения об ошибке в интерфейсе
                    servicesList.innerHTML = '<div class="no-records">Ошибка загрузки данных</div>';
                });
        }

        // Функция для отображения услуг в списке
        function displayServices(services) {
            // Проверка, есть ли записи в полученном массиве
            if (services.length === 0) {
                // Если массив пустой, показ сообщения "Услуг нет"
                servicesList.innerHTML = '<div class="no-records">Записей нет.</div>';
                return;
            }

            // Создание переменной для накопления HTML разметки
            let html = '';

            // Прохождение по каждой услуге в массиве services
            services.forEach((service, index) => {
                // Для каждой услуги создание HTML карточки:
                // - data-service-id: уникальный идентификатор услуги из базы данных
                // - record-number: порядковый номер
                // - record-name: название услуги
                // - record-price: цена услуги
                html += `
                    <div class="record-card" data-service-id="${service.ID}">
                        <div class="record-content">
                            <div class="record-details">
                                <div class="record-number">${index + 1}.</div>
                                <div class="record-name">${service.name || ''}</div>
                                <div class="record-price">${service.price || ''} ₽</div>
                            </div>
                        </div>
                    </div>
                `;
            });

            // Вставление сгенерированной HTML разметки в контейнер списка
            servicesList.innerHTML = html;
        }

        // Функция для валидации цены (только цифры)
        function validatePrice(input) {
            // Сохраняем позицию курсора
            const cursorPosition = input.selectionStart;
            
            // Удаляем все символы, кроме цифр
            const newValue = input.value.replace(/[^\d]/g, '');
            
            // Устанавливаем новое значение
            input.value = newValue;
            
            // Восстанавливаем позицию курсора
            input.setSelectionRange(cursorPosition, cursorPosition);
        }

        // Обработчик ввода для поля цены
        priceInput.addEventListener('input', function() {
            validatePrice(this);
        });

        // Функция для закрытия модального окна
        function closeModal() {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
            document.getElementById('name').value = '';
            document.getElementById('price').value = '';
        }

        // Открытие модального окна
        openModalBtn.addEventListener('click', function() {
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        });

        // Сохранение данных услуги
        saveBtn.addEventListener('click', function() {
            const name = document.getElementById('name').value;
            const price = document.getElementById('price').value;

            // Проверяем, что все поля заполнены
            if (!name || !price) {
                alert('Заполните все поля!');
                return;
            }

            // Проверяем, что цена состоит только из цифр
            if (!/^\d+$/.test(price)) {
                alert('Цена должна содержать только цифры!');
                return;
            }

            // Собираем данные из формы
            const serviceData = {
                name: name,
                price: parseInt(price) // Преобразуем в число
            };

            // Отправляем данные на сервер
            fetch('/services', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(serviceData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Ошибка сервера');
                }
                return response.json();
            })
            .then(data => {
                console.log('Услуга сохранена:', data);
                alert('Услуга успешно добавлена!');
                closeModal();
                loadServices();
            })
            .catch(error => {
                console.error('Ошибка при сохранении:', error);
                alert('Ошибка при сохранении: ' + error.message);
            });
        });

        // Закрытие по кнопке Удалить
        deleteBtn.addEventListener('click', function() {
            closeModal();
        });

        loadServices();
    });
</script>
{% endblock %}